---
title: "Weather and Corn Yield Regressions"
author: "Nathan Mueller, Assignment: Amanda Hastings"
date: "2/25/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(R.matlab)
library(rnassqs)
```

## Weather Data Analysis

### Load the PRISM daily maximum temperatures

```{r tmax data}

# daily max temperature
# dimensions: counties x days x years
prism <- readMat("data/prismiowa.mat")

# look at county #1
t_1981_c1 <- prism$tmaxdaily.iowa[1,,1]
t_1981_c1[366]
plot(1:366, t_1981_c1, type = "l")

ggplot() +
  geom_line(mapping = aes(x=1:366, y = t_1981_c1)) +
  theme_bw() +
  xlab("day of year") +
  ylab("daily maximum temperature (°C)") +
  ggtitle("Daily Maximum Temperature, Iowa County #1")


```


```{r tidying up}

# assign dimension names to tmax matrix
dimnames(prism$tmaxdaily.iowa) <- list(prism$COUNTYFP, 1:366, prism$years)

# converted 3d matrix into a data frame
tmaxdf <- as.data.frame.table(prism$tmaxdaily.iowa)

# relabel the columns
colnames(tmaxdf) <- c("countyfp","doy","year","tmax")
tmaxdf <- tibble(tmaxdf)

```

## Temperature trends

### Summer temperature trends: Winneshiek County

```{r temp trends}

tmaxdf$doy <- as.numeric(tmaxdf$doy)
tmaxdf$year <- as.numeric(as.character(tmaxdf$year))

winnesummer <- tmaxdf %>%
  filter(countyfp==191 & doy >= 152 & doy <= 243) %>%
  group_by(year) %>%
  summarize(meantmax = mean(tmax))

ggplot(winnesummer, mapping = aes(x = year, y = meantmax)) +
  geom_point() +
  theme_bw() +
  labs(x = "year", y = "Tmax (°C)") +
  geom_smooth(method = lm)

lm_summertmax <- lm(meantmax ~ year, winnesummer)
summary(lm_summertmax)

```

### Winter Temperatures - Winneshiek County

```{r winter temps}

winnewinter <- tmaxdf %>%
  filter(countyfp==191 & (doy <= 59 | doy >= 335) & !is.na(tmax)) %>%
  group_by(year) %>%
  summarize(meantmax = mean(tmax))

ggplot(winnewinter, mapping = aes(x = year, y = meantmax)) +
  geom_point() +
  theme_bw() +
  labs(x = "year", y = "Tmax (°C)") +
  geom_smooth(method = lm)

lm_wintertmax <- lm(meantmax ~ year, winnewinter)
summary(lm_wintertmax)

```

### Multiple regression -- Quadratic time trend

```{r quadratic temp trend}

winnewinter$yearsq <- winnewinter$year^2

lm_wintertmaxquad <- lm(meantmax ~ year + yearsq, winnewinter)
summary(lm_wintertmaxquad)
winnewinter$fitted <- lm_wintertmaxquad$fitted.values

ggplot(winnewinter) +
  geom_point(mapping = aes(x = year, y = meantmax)) +
  geom_line(mapping = aes(x = year, y = fitted)) +
  theme_bw() +
  labs(x = "year", y = "tmax")

```

### Download NASS corn yield data

```{r yield download, echo=TRUE, include=FALSE}

# set our API key with NASS
nassqs_auth(key = "AA4F0FBD-6240-3D5A-902F-54E62A4E05F0")

# parameters to query on 
params <- list(commodity_desc = "CORN", util_practice_desc = "GRAIN", prodn_practice_desc = "ALL PRODUCTION PRACTICES", year__GE = 1981, state_alpha = "IA")

# download
cornyieldsall <- nassqs_yields(params)

cornyieldsall$county_ansi <- as.numeric(cornyieldsall$county_ansi)
cornyieldsall$yield <- as.numeric(cornyieldsall$Value)

# clean and filter this dataset
cornyields <- select(cornyieldsall, county_ansi, county_name, yield, year) %>%
  filter(!is.na(county_ansi) & !is.na(yield))
cornyields <- tibble(cornyields)

```

## Assignment

### Question 1a: Extract Winneshiek County corn yields, fit a linear time trend, make a plot. Is there a significant time trend?

#### **Linear time trend analysis within Winneshiek County, Iowa**

#### *SLR - Yield by Covariate: Year*

```{r}

#Load libraries 

library(ggthemes)
library(broom)
library(viridis)
library(viridisLite)
```


```{r}
#Extract Winneshiek County corn yields 

winne_yields <- cornyields %>%
  filter(county_ansi == 191)

# Fit a model for yield as the response (y) and year as predictor (x) 

winne_timeLM <- lm(yield ~ year, data = winne_yields)
summary(winne_timeLM)

#Add fitted values from linear model to data frame 

winne_yields$fitted_l <- winne_timeLM$fitted.values

#Plot corn yield(y) by year(x)
#Add line for linear time trend 

ggplot(aes(x = year, y = yield), data = winne_yields) +
  geom_point(shape = 1) +
  geom_line(mapping = aes(x = year, y = fitted_l)) +
  theme_few() +
  labs(x = "Year", y = "Yield (Bu/Acre)", title = "Winneshiek County, IA - Corn Yield (Linear Time Trend)") 

```

With a p-value of 1.77e-13 and less than $\alpha$ = 0.05, we reject the null hypothesis $H_0:\beta_1$ = 0. We have enough evidence to suggest there is a significant time trend and a positive linear relationship between year and yield. There is an estimated 2.457 bu/acre increase in corn yield with each increasing year. 75.51% of the variation in corn yield is explained by the regression on year. 


### Question 1b: Fit a quadratic time trend (i.e., year + year^2) and make a plot. Is there evidence for slowing yield growth? 

#### **Quadratic time trend analysis within Winneshiek County, Iowa**

#### *Quadratic Regression - Yield by Covariates: Year,Year^2*

```{r}

# Create column for year^2 

winne_yields$yearsq <- winne_yields$year^2

#Fit quadratic time trend with yield(y) and year and year^2 as covariates(x)

quad_timeLM <- lm(yield~year + yearsq, data = winne_yields)
summary(quad_timeLM)

#Add fitted values from the quad model to data frame 

winne_yields$fitted_q <- quad_timeLM$fitted.values

#Plot yield(y) by year (x) 
#Add line for quadratic time trend

ggplot(winne_yields) +
  geom_point(mapping = aes(x = year, y = yield), shape = 1) +
  geom_line(mapping = aes(x = year, y = fitted_q)) +
  theme_few() +
  labs(x = expression("Year"), y = "Yield (Bu/Acre)", title = "Winneshiek County, IA - Corn Yield (Quadratic Time Trend)")

```


There is not strong evidence to suggest there is slowing yield growth over time. The R-squared values between the linear model and quadratic model with regressor(s) year and/or year^2 are comparable at 75.51% or 75.59%, respectively. Overall, 74.31% (Adjusted R-squared) of the variation in yield is explained by the quadratic regression on year (and year^2); however, this is slightly less the variation in yield explained by the regression on year alone (75.51%). This suggests the higher order model, with adding in year^2, does not provide greater predictive ability in the model.


```{r}

#Plot time trend lines combined 

ggplot(winne_yields) +
  geom_point(mapping = aes(x = year, y = yield), shape = 1) +
  geom_line(mapping = aes(x = year, y = fitted_l, col="Linear Time Trend"), size=1) +
  geom_line(mapping = aes(x = year, y = fitted_q, col="Quadratic Time Trend"),size=1) +
  theme_few() +
  labs(colour = NULL) +
  scale_color_manual(values=c("#FFC300","#900C3F"))+
  labs(x = expression("Year"), y = "Yield (Bu/Acre)", title = "Winneshiek County, IA - Corn Yield Over Time")

```


```{r include=FALSE}

#Plot yield(y) by year^2 (x), use geom_smooth for quadratic line 
# 
# ggplot(aes(x = yearsq, y = yield), data = winne_yields) +
#   geom_point(shape = 1) +
#   theme_few() +
#   labs(x = expression("Year" ^ 2),
#        y = "Corn Yields",
#        title = "Winneshiek County Corn Yield") +
#   geom_smooth(
#     method = "lm",
#     formula = y ~ poly(x, 2),
#     se = FALSE,
#     size = 0.5
#     ,
#     color = "black"
#   )
```


### Question 2 -- Time Series: Let's analyze the relationship between temperature and yields for the Winneshiek County time series. Use data on yield and summer avg Tmax. Is adding year or Tmax^2 to your model helpful? Make a plot and interpret the results.

#### **Time series analysis within Winneshiek County, Iowa**

#### *SLR - Yield by Covariate: Average Summer Maximum Temperature*

```{r}

#Add average summer Tmax to winne_yield data 

winne_summer_yield <- left_join(winne_yields,winnesummer, by = "year")%>% 
  filter(!is.na(meantmax))

#Fit a model for yield(y) and average summer maximum temperature(x) alone 

winne_tempLM <- lm(yield~meantmax, data=winne_summer_yield)
summary(winne_tempLM)

#Add fitted values to data frame 

winne_summer_yield$fitted_2 <- winne_tempLM$fitted.values

```


With a p-value of 0.2902 and greater than $\alpha$ = 0.05, we fail to reject the null hypothesis $H_0:\beta_1$ = 0. We do not have sufficient evidence to suggest there is a linear relationship between average summer maximum temperature and yield. 3.1% of the variation in corn yield is explained by the regression on average summer maximum temperature alone. 


#### *Multiple Regression - Yield by Covariates: Average Summer Maximum Temperature, Year* 

```{r}
#Add summer Tmax^2 to winne_summer_yield 

winne_summer_yield$meantmaxsq <- winne_summer_yield$meantmax^2

#Fit a model for yield(y) with covariates(x): average summer max temp and year 

temp_yearLM <- lm(yield~meantmax + year, data=winne_summer_yield)
summary(temp_yearLM)

#Add fitted values from model to data frame 

winne_summer_yield$fitted_2a <- temp_yearLM$fitted.values

```


With a p-value of 1.01e-11 and less than $\alpha$ = 0.05, we reject the null hypothesis $H_0:\beta_1 = \beta_2$ = 0. We have evidence of a positive linear relationship between year and yield, when average summer max temp is held constant. There is an estimated 2.514 bu/acre increase in corn yield with each increasing year, holding all else constant. 73.18% (Adjusted R-squared) of the variation in corn yield is explained by the regression on average summer maximum temperature and year. Thus, adding year to the original model analyzing yield by average summer maximum temperature is helpful. 


#### *Quadratic Regression - Yield by Covariates: Average Summer Max Temperature, Max Temperature^2*

```{r}

#Fit a model for yield with covariates: average summer max temp and max temp^2 

quad_tempLM <- lm(yield~meantmax + meantmaxsq, data=winne_summer_yield)
summary(quad_tempLM)

#Add fitted values from model to data frame 

winne_summer_yield$fitted_2b <- quad_tempLM$fitted.values

```


In prior analyses, we found there was not sufficient evidence of a linear relationship between yield and average summer max temp (p-value = 0.2902, R^2 = 3.1%). However, in adding the quadratic term to the model (Tmax^2), 19.84% (Adjusted R-squared) of the variation in corn yield is explained by the regression on average summer max temp and average summer max temp squared. The quadratic model, therefore, describes greater variability in yield above and beyond the regression on average summer max temp alone. Furthermore, the p-value from the quadratic model F-test is 0.007887 and less than $\alpha$ = 0.05, whereas the p-value from the linear model F-test is 0.2902. This suggests the higher order model serves as a better predictive model. 


```{r}

#Plot corn yield (y) by Average Summer Maximum Temperature(x) with fitted values from regressions 

ggplot(winne_summer_yield) +
  geom_point(mapping = aes(x = meantmax, y = yield), shape = 1) +
  geom_line(mapping = aes(x = meantmax, y = fitted_2, col="SLR")) +
  geom_line(mapping = aes(x = meantmax, y = fitted_2a, col="MR with year")) +
  geom_line(mapping = aes(x = meantmax, y = fitted_2b, col="QR")) +
  labs(colour = NULL) +
  theme_few() +
  scale_color_viridis(discrete=TRUE)+
  labs(x = expression("Average Summer Maximum Temperature ("*degree*C*")"), y = "Yield (Bu/Acre)", title = "Winneshiek County, IA - Corn Yield")
```


### Question 3 -- Cross-Section: Analyze the relationship between temperature and yield across all counties in 2018. Is there a relationship? Interpret the results.

#### **Cross-section analysis across all Iowa Counties in 2018**

```{r}
#Rename county_ansi to countyfp 

corn_yields <- cornyields %>% 
  rename('countyfp'= county_ansi)

#Save countyfp as factor 

corn_yields$countyfp <- as.factor(corn_yields$countyfp)

#Filter for 2018 yields only 

county2018_yields <- corn_yields %>% 
  filter(year==2018)

#Add average summer maximum temp for 2018 

tmax2018 <- tmaxdf %>% 
  filter(year==2018)%>% 
  group_by(countyfp) %>% 
  filter(doy >= 152 & doy <= 243) %>%
  summarize(meantmax = mean(tmax))

#Combine average summer max temperature with county yield data for 2018 

countytmax2018 <- inner_join(county2018_yields, tmax2018, by='countyfp')
```


#### *SLR - Yield by Covariate: Average Summer Max Temperature*

```{r}

#Fit a linear model with yield (y) and average summer Tmax (x) 

yield_2018LM <- lm(yield~meantmax, data=countytmax2018)
summary(yield_2018LM)

#Add fitted values from model to data frame 

countytmax2018$fitted_l <-yield_2018LM$fitted.values

#Plot yield(y) by average summer maximum temperature (x)

# ggplot(aes(x = meantmax, y = yield), data = countytmax2018) +
#   geom_point(shape = 1) +
#   geom_line(mapping = aes(x=meantmax, y=fitted_l))+
#   theme_few() +
#   labs(x = expression("Average Summer Maximum Temperature ("*degree*C*")"), y = "Yield (Bu/Acre)", title = "Corn Yields across Iowa Counties in 2018")
```


#### *QR - Yield by Covariates: Average Summer Max Temperature, Max Temperature^2*


```{r}

#Add Tmax^2 to data frame 

countytmax2018$meantmaxsq <- countytmax2018$meantmax^2

#Fit a quadratic model with yield (y) and average summer Tmax and Tmax^2

yield_2018_QR<- lm(yield~meantmax + meantmaxsq, data=countytmax2018)
summary(yield_2018_QR)

#Add fitted values from model to data frame 

countytmax2018$fitted_q <-yield_2018_QR$fitted.values

#Plot yield(y) by average summer maximum temperature (x)

# ggplot(aes(x = meantmax, y = yield), data = countytmax2018) +
#   geom_point(shape = 1) +
#   geom_line(mapping = aes(x=meantmax, y=fitted_q))+
#   theme_few() +
#   labs(x = expression("Average Summer Maximum Temperature ("*degree*C*")"), y = "Yield (Bu/Acre)", title = "Corn Yields across Iowa Counties in 2018")
```



```{r}

#Combined plot of linear and quadratic temperature models

ggplot(aes(x = meantmax, y = yield), data = countytmax2018) +
  geom_point(shape = 1) +
  geom_line(mapping = aes(x=meantmax, y=fitted_l, col="Linear Temperature Trend"))+
  geom_line(mapping = aes(x=meantmax, y=fitted_q, col="Quadratic Temperature Trend"))+
  labs(colour = NULL) +
  theme_few() +
  scale_color_viridis(discrete=TRUE)+
  labs(x = expression("Average Summer Maximum Temperature ("*degree*C*")"), y = "Yield (Bu/Acre)", title = "Corn Yields across Iowa Counties in 2018")
```



### Question 4 -- Panel: One way to leverage multiple time series is to group all data into what is called a "panel" regression. Convert the county ID code ("countyfp" or "county_ansi") into factor using as.factor, then include this variable in a regression using all counties' yield and summer temperature data. How does the significance of your temperature coefficients (Tmax, Tmax^2) change? Make a plot comparing actual and fitted yields and interpret the results of your model.


```{r}
#Combine county and temperature data 

yearly_co_temp <- tmaxdf %>% 
  group_by(countyfp,year)%>% 
  filter(doy >= 152 & doy <= 243) %>%
  summarize(meantmax = mean(tmax))

  
co_yearly_join <- left_join(yearly_co_temp, corn_yields, by= c('countyfp','year'))%>% 
  filter(!is.na(yield))

#Add Tmax^2 to data frame 

co_yearly_join$meantmaxsq <- co_yearly_join$meantmax^2
```

#### *SLR - Yield by Covariate: Year*

```{r}

SLR_LM <- lm(yield~ year, data = co_yearly_join)
summary(SLR_LM)

co_yearly_join$fit_SLR <- SLR_LM$fitted.values

# Plot actual versus fitted yields 

ggplot(co_yearly_join) +
  geom_point(mapping = aes(x = yield, y = fit_SLR), shape = 1) +
  geom_abline(color="#B3B61A", size=0.75)+
  theme_few() +
  labs(x = "Actual Yield", y = "Fitted Values", title="Simple Linear Regression: Yield by Year")
```


#### *Quadratic Regression - Yield by Covariates: Average Summer Maximum Temperature, Max Temperature^2*

```{r}

QR_LM <- lm(yield~ meantmax+ meantmaxsq, data = co_yearly_join)
summary(QR_LM)

co_yearly_join$fit_QR <- QR_LM$fitted.values

# Plot actual versus fitted yields 

ggplot(co_yearly_join) +
  geom_point(mapping = aes(x = yield, y = fit_QR), shape = 1) +
   geom_abline(color="#B3B61A", size=0.75)+
  theme_few() +
  labs(x = "Actual Yield", y = "Fitted Values", title="Quadratic Regression: Yield by Average Summer Maximum Temperature")
```


#### *Multiple Regression - Yield by Covariates: Average Summer Maximum Temperature, Max Temperature^2, Year* 

```{r}

# Fit multiple regression yield by Average Summer Maximum Temperature, Max Temperature^2, Year

MR_LM <- lm(yield~ meantmax+ meantmaxsq+ year, data = co_yearly_join)
summary(MR_LM)

co_yearly_join$fit_MR <- MR_LM$fitted.values

# Plot actual versus fitted yields 

ggplot(co_yearly_join) +
  geom_point(mapping = aes(x = yield, y = fit_MR), shape = 1) +
  geom_abline(color="#B3B61A", size=0.75)+
  theme_few() +
  labs(x = "Actual Yield", y = "Fitted Values", title="Multiple Regression: Yield by Year and Quadratic Temperature")
```


#### *Panel Regression - Yield by Covariates: Average Summer Maximum Temperature, Max Temperature^2, Year, County code* 

```{r}

#Fit a panel regression

panelLM <- lm(yield~ meantmax+ meantmaxsq+ year+countyfp, data = co_yearly_join)
summary(panelLM)

co_yearly_join$fit_panel <- panelLM$fitted.values

# Plot actual versus fitted yields 

ggplot(co_yearly_join) +
  geom_point(mapping = aes(x = yield, y = fit_panel), shape = 1) +
  geom_abline(color="#B3B61A", size=0.75)+
  theme_few()+
  labs(x = "Actual Yield", y = "Fitted Values", title="Panel Regression")

```


### Question 5 -- Soybeans: Download NASS data on soybean yields and explore either a time series relationship for a given county, the cross-sectional relationship for a given year, or a panel across all counties and years.

```{r soybean download, echo=TRUE, include=FALSE}

#Download NASS data on soybean yields

#Parameters for soybean data

params2 <- list(commodity_desc = "SOYBEANS",prodn_practice_desc = "ALL PRODUCTION PRACTICES", year__GE = 1981, agg_level_desc = "STATE", state_alpha = "IA")

soyyieldall <- nassqs_yields(params2)

soyyieldall$county_ansi <- as.numeric(soyyieldall$county_ansi)
soyyieldall$yield <- as.numeric(soyyieldall$Value)

#Tidy dataset

soyyields <-
  select(soyyieldall, county_ansi, county_name, yield, year) %>%
  filter(!is.na(county_ansi) & !is.na(yield))

soyyields <- tibble(soyyields)

```


### Bonus: Find a package to make a county map of Iowa displaying some sort of information about yields or weather. Interpret your map.

```{r}

#Load packages to create county map of Iowa 

library(USAboundaries)
library(USAboundariesData)
library(mapview)

#Select needed columns 

counties <- us_counties(states = 'iowa') %>%
  dplyr::select(name, geometry)

#Adjust capitalization of county names 

counties$name <- toupper(counties$name)

```


```{r}

#Simplify data by only mapping yield data from one year 

cornyield_2017 <- corn_yields %>%
  filter(year==2017) %>% 
  dplyr::select(county_name, yield, countyfp)
  
#Combine yield and spatial county data 

co_yields <- merge(counties, cornyield_2017, by.x = "name", by.y = "county_name", all.x=TRUE)

#Map yield by county 

mapview(co_yields, zcol= 'yield')
```


### Bonus #2: Challenge question - map trends in corn yields by county across Iowa. Interpret your map.

```{r}

```









